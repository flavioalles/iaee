#!/usr/bin/python

from os import devnull as DEVNULL
import os.path
import socket
import subprocess
import sys

def startmaster(IAEE_HOME, quiet):
   if quiet:
      # java -jar IAEE_HOME/jar/iaee.jar -m
      #subprocess.call(['java', '-jar', IAEE_HOME + '/jar/iaee.jar', '-m', '&>', IAEE_HOME + '/.master/master-' + str(socket.gethostname()) + '.tty', '&'])
      #subprocess.call(['java', '-jar', IAEE_HOME + '/iaee.jar', '-m', '&>', IAEE_HOME + '/.master.tty', '&']) #dbg
      #subprocess.call(['java', '-jar', IAEE_HOME + '/iaee.jar', '-m'], stdout=open(IAEE_HOME + '/.master.tty', 'a'), stderr=open(IAEE_HOME + '/.master-stderr.tty', 'a')) #dbg
      subprocess.Popen(['java', '-jar', IAEE_HOME + '/iaee.jar', '-m'], stdout=open(IAEE_HOME + '/.master.tty', 'a'), stderr=open(IAEE_HOME + '/.master-stderr.tty', 'a')) #dbg
   else:
      #subprocess.call(['java', '-jar', IAEE_HOME + '/jar/iaee.jar', '-m', '&'])
      #subprocess.call(['java', '-jar', IAEE_HOME + '/iaee.jar', '-m', '&']) #dbg
      subprocess.call(['java', '-jar', IAEE_HOME + '/iaee.jar', '-m']) #dbg
   # update IAEE_HOME/.master/master-$HOSTNAME.pid
   pid = subprocess.check_output(['echo', '$?'], stderr=open(DEVNULL, 'wb'))
   #pidfile = open(IAEE_HOME + '/.master/master-' + str(socket.gethostname()) + '.pid', 'w')
   pidfile = open(IAEE_HOME + '/.master.pid', 'w') #dbg
   pidfile.write(pid + '\n')
   pidfile.close()
   return True

def helpmsg(IAEE_HOME):
   print("iaee-master: starts a master (server) iaee instance.")
   print
   print("Usage:")
   print("     <iaee-master> runs verbosely, printing everything to current terminal.")
   print("     <iaee-master quiet> quiet run - output is redirected to " + IAEE_HOME + "/.master/master-" + str(socket.gethostname()) + ".tty.")
   print("     <iaee-master help> prints this help message.")
   print
   return True

def gethelpmsg():
   print("Wrong usage.")
   print("Type <iaee-master> for usage instructions.")
   return True

def main(argv):
   IAEE_HOME = os.path.expanduser('~') + '/.iaee' 
   if len(argv) == 0:
      startmaster(IAEE_HOME, False)
   elif len(argv) == 1:
      if argv[0] == 'quiet':
         startmaster(IAEE_HOME, True)
      elif argv[0] == 'help':
         helpmsg(IAEE_HOME)
      else:
         gethelpmsg()
   else:
      gethelpmsg()

if __name__ == "__main__":
   main(sys.argv[1:])
